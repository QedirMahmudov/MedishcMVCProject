@model UpdatePatientVM
@{
    int i = 0;
}
<div class="app-body">
    <!-- Row starts -->
    <div class="row gx-3">
        <div class="col-xl-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Create Patient Profile</h4>
                    <p class="card-description">Patient registration form</p>

                    <!-- Form starts here -->
                    <form method="post" enctype="multipart/form-data" class="forms-sample" id="updateForm">

                        <!-- Custom tabs starts -->
                        <div class="custom-tabs-container">

                            <!-- Nav tabs starts -->
                            <ul class="nav nav-tabs" id="customTab2" role="tablist">
                            </ul>
                            <!-- Nav tabs ends -->
                            <!-- Tab content starts -->
                            <div class="tab-content h-350">
                                <div class="tab-pane fade show active" id="oneA" role="tabpanel">
                                    <!-- Row starts -->
                                    <div class="row gx-3">
                                        <div class="form-group">
                                            <img style="width:200px;height=150px" src="/assets/images/patient/@Model.Image" alt="Alternate Text" />
                                            <input type="hidden" value="@Model.Image" asp-for="Image" class="form-control">
                                        </div>
                                        <div class="col-xxl-3 col-lg-4 col-sm-6">
                                            <div class="form-group">
                                                <label asp-for="MainPhoto">Main Image <span class="text-danger">*</span></label>
                                                <input asp-for="MainPhoto" accept="image/*" class="form-control">
                                                <span class="text-danger" asp-validation-for="MainPhoto"></span>
                                            </div>
                                        </div>
                                        <div class="col-xxl-3 col-lg-4 col-sm-6">
                                            <div class="mb-3">
                                                <label class="form-label" asp-for="Name">Name <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="ri-account-circle-line"></i>
                                                    </span>
                                                    <input asp-for="Name" type="text" class="form-control" placeholder="Enter Name">
                                                </div>
                                                <span class="text-danger" asp-validation-for="Name"></span>
                                            </div>
                                        </div>
                                        <div class="col-xxl-3 col-lg-4 col-sm-6">
                                            <div class="mb-3">
                                                <label class="form-label" asp-for="Surname">Surname <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="ri-account-circle-line"></i>
                                                    </span>
                                                    <input asp-for="Surname" type="text" class="form-control" placeholder="Enter Surname">
                                                </div>
                                                <span class="text-danger" asp-validation-for="Surname"></span>
                                            </div>
                                        </div>
                                        <div class="col-xxl-3 col-lg-4 col-sm-6">
                                            <div class="mb-3">
                                                <label class="form-label" asp-for="Age">Age <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="ri-account-circle-line"></i>
                                                    </span>
                                                    <input asp-for="Age" type="number" class="form-control" placeholder="Enter Age">
                                                </div>
                                                <span class="text-danger" asp-validation-for="Age"></span>
                                            </div>
                                        </div>
                                        <div class="col-xxl-3 col-lg-4 col-sm-6">
                                            <div class="mb-3">
                                                <label class="form-label" asp-for="Gender">Gender <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="ri-user-3-line"></i>
                                                    </span>
                                                    <select asp-for="Gender" class="form-select">
                                                        <option selected disabled value="">Choose Gender</option>
                                                        <option value="0">Male</option>
                                                        <option value="1">Female</option>
                                                    </select>
                                                </div>
                                                <span class="text-danger" asp-validation-for="Gender"></span>
                                            </div>
                                        </div>
                                        <div class="col-xxl-3 col-lg-4 col-sm-6">
                                            <div class="mb-3">
                                                <label class="form-label" asp-for="BloodGroupId">Blood Group <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="ri-copper-diamond-line"></i>
                                                    </span>
                                                    <select asp-for="BloodGroupId" class="form-select" asp-items="@(new SelectList(Model.BloodGroups, nameof(BloodGroup.Id), nameof(BloodGroup.Name)))">
                                                        <option selected disabled>Choose Blood Group</option>

                                                    </select>
                                                </div>
                                                <span class="text-danger" asp-validation-for="BloodGroupId"></span>
                                            </div>
                                        </div>
                                        <div class="col-xxl-3 col-lg-4 col-sm-6">
                                            <div class="mb-3">
                                                <label class="form-label" asp-for="DiseaseId">Disease <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="ri-copper-diamond-line"></i>
                                                    </span>
                                                    <select asp-for="DiseaseId" class="form-select" asp-items="@(new SelectList(Model.Diseases, nameof(Disease.Id), nameof(Disease.Name)))">
                                                        <option selected disabled>Choose Disease</option>

                                                    </select>
                                                </div>
                                                <span class="text-danger" asp-validation-for="DiseaseId"></span>
                                            </div>
                                        </div>
                                        <div class="col-xxl-3 col-lg-4 col-sm-6">
                                            <div class="mb-3">
                                                <label class="form-label" asp-for="Email">Email <span class="text-danger"></span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="ri-mail-open-line"></i>
                                                    </span>
                                                    <input asp-for="Email" type="email" class="form-control" placeholder="Enter Email">
                                                </div>
                                                <span class="text-danger" asp-validation-for="Email"></span>
                                            </div>
                                        </div>
                                        <div class="col-xxl-3 col-lg-4 col-sm-6">
                                            <div class="mb-3">
                                                <label class="form-label" asp-for="PhoneNumber">Mobile Number <span class="text-danger"></span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="ri-phone-line"></i>
                                                    </span>
                                                    <input asp-for="PhoneNumber" type="text" class="form-control" placeholder="Enter Mobile Number">
                                                </div>
                                                <span class="text-danger" asp-validation-for="PhoneNumber"></span>
                                            </div>
                                        </div>
                                        <div class="col-xxl-3 col-lg-4 col-sm-6">
                                            <div class="mb-3">
                                                <label class="form-label" asp-for="SocialMediaFacebook">Facebook <span class="text-danger"></span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="ri-account-circle-line"></i>
                                                    </span>
                                                    <input asp-for="SocialMediaFacebook" class="form-control" placeholder="Enter Facebook">
                                                </div>
                                                <span class="text-danger" asp-validation-for="SocialMediaFacebook"></span>
                                            </div>
                                        </div>
                                        <div class="col-xxl-3 col-lg-4 col-sm-6">
                                            <div class="mb-3">
                                                <label class="form-label" asp-for="SocialMediaTwitter">Twitter <span class="text-danger"></span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="ri-account-circle-line"></i>
                                                    </span>
                                                    <input asp-for="SocialMediaTwitter" class="form-control" placeholder="Enter Twitter">
                                                </div>
                                                <span class="text-danger" asp-validation-for="SocialMediaTwitter"></span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label asp-for="MainDescription">Main Description<span class="text-danger"> *</span></label>
                                            <textarea rows="5" asp-for="MainDescription" class="form-control" placeholder="Main Description"></textarea>
                                            <span class="text-danger" asp-validation-for="MainDescription"></span>
                                        </div>

                                        <div class="form-group mt-3">
                                            <label class="form-label">Report File (PDF) <span class="text-danger">*</span></label>

                                            <label for="ReportFiles" class="d-flex flex-column bg-light p-2 rounded-2 text-center" style="cursor:pointer;">
                                                <h6 class="mt-3 mb-1 text-truncate">Click here to upload your report file</h6>
                                                <p class="m-0 small">Upload your health reports.</p>
                                            </label>

                                            <input type="file"
                                                   id="ReportFiles"
                                                   name="ReportFiles"
                                                   accept="application/pdf"
                                                   class="form-control d-none"
                                                   multiple />

                                            <span asp-validation-for="ReportFiles" class="text-danger mt-1 d-block"></span>

                                            <div id="existing-files" class="mb-3 d-flex flex-wrap gap-2">
                                                @foreach (var file in Model.ExistingReports)
                                                {
                                                    <div class="file-chip" data-id="@file.Id">
                                                        <span style="cursor:pointer;" title="Click to preview"
                                                              onclick="previewExistingPdf('@file.FileUrl')">
                                                            @file.FileName
                                                        </span>
                                                        <i class="fas fa-times ms-2" title="Remove file" onclick="removeExistingFile(this, @file.Id)"></i>
                                                    </div>
                                                }
                                            </div>

                                            <div id="selected-files" class="mb-3 d-flex flex-wrap gap-2"></div>
                                        </div>

                                        <!-- PDF Preview Modal -->
                                        <div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 90%;">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="pdfModalLabel">Preview PDF</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <iframe id="pdfPreviewFrame" style="width: 100%; height: 80vh;" frameborder="0"></iframe>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Row ends -->
                                </div>
                            </div>
                            <!-- Tab content ends -->

                        </div>
                        <!-- Custom tabs ends -->
                        <!-- Card acrions starts -->
                        <div class="d-flex gap-2 justify-content-end mt-4">
                            <button class="btn btn-light">Cancel</button>
                            <button type="submit" class="btn btn-primary me-2">Submit</button>
                        </div>
                        <!-- Card acrions ends -->
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Row ends -->

</div>



<ul id="selected-files" class="mt-2 small text-secondary"></ul>





<style>
    .file-chip {
        display: flex;
        align-items: center;
        background-color: #f1f1f1;
        border-radius: 20px;
        padding: 6px 12px;
        font-size: 0.875rem;
        color: #333;
        max-width: 100%;
        white-space: nowrap;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        transition: background-color 0.2s;
    }

        .file-chip:hover {
            background-color: #e6e6e6;
        }

        .file-chip i {
            margin-left: 8px;
            cursor: pointer;
            color: #dc3545;
            transition: color 0.2s ease;
        }

            .file-chip i:hover {
                color: #a71d2a;
            }

    #selected-files, #existing-files {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }

    #existing-files {
        margin-top: 15px;
    }
</style>





<script>
    // 📄 PDF preview üçün (mövcud + yeni blob üçün işləyir)
    function previewExistingPdf(fileUrl) {
        const iframe = document.getElementById("pdfPreviewFrame");
        iframe.src = fileUrl;

        const modal = new bootstrap.Modal(document.getElementById("pdfModal"));
        modal.show();
    }

    // ❌ Mövcud report-u silmək üçün (bazadakılar)
    function removeExistingFile(icon, fileId) {
        icon.closest('.file-chip').remove();

        const removedInput = document.createElement('input');
        removedInput.type = 'hidden';
        removedInput.name = 'RemovedReportIds';
        removedInput.value = fileId;

        document.getElementById('updateForm').appendChild(removedInput);
    }

    // 📥 Yeni seçilən PDF faylların siyahısı
    let selectedFileList = [];

    document.addEventListener("DOMContentLoaded", function () {
        const reportInput = document.getElementById("ReportFiles");
        const selectedFilesContainer = document.getElementById("selected-files");

        if (reportInput) {
            reportInput.addEventListener("change", function () {
                Array.from(this.files).forEach(file => {
                    // 🔁 Eyni adda faylı təkrar etmə
                    if (selectedFileList.includes(file.name)) return;

                    selectedFileList.push(file.name);

                    const div = document.createElement("div");
                    div.classList.add("file-chip");

                    // 📎 Fayl adını göstərən span (preview açır)
                    const nameSpan = document.createElement("span");
                    nameSpan.textContent = file.name;
                    nameSpan.style.cursor = "pointer";
                    nameSpan.title = "Click to preview";

                    // 🧠 Blob URL yaradıb preview aç
                    nameSpan.addEventListener("click", function () {
                        const blobUrl = URL.createObjectURL(file);
                        previewExistingPdf(blobUrl);
                    });

                    div.appendChild(nameSpan);

                    // ❌ Sil düyməsi
                    const removeIcon = document.createElement("i");
                    removeIcon.classList.add("fas", "fa-times", "ms-2");
                    removeIcon.title = "Remove file";
                    removeIcon.style.cursor = "pointer";

                    removeIcon.addEventListener("click", function () {
                        div.remove();
                        selectedFileList = selectedFileList.filter(f => f !== file.name);
                    });

                    div.appendChild(removeIcon);

                    // 🧩 Aşağıya əlavə et
                    selectedFilesContainer.appendChild(div);
                });
            });
        }
    });
</script>